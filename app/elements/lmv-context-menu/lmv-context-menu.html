<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="lmv-context-menu" attributes="">
  <template>
    <link rel="stylesheet" href="lmv-context-menu.css">
    <is-mobile mobile="{{isMobile}}"></is-mobile>
    <content></content>
  </template>
  <script>
    (function () {
      var _this;
      var _lastX, _lastY;
      var _DELTA_EPS = 5;

      function openContextMenu(x,y) {
        _this.show = true;
        _this.style.left = x + "px";
        _this.style.top = y + "px";
        _this.fire("open");
      }
      function closeContextMenu() {
        _this.show = false;
        _this.fire("close");
      }

      function onMouseDown(e) {
        if (e.button !== 2)
          return;
        _lastX = e.x;
        _lastY = e.y;
      }
      function onMouseUp(e) {
        if (e.button !== 2)
          return;
        if (Math.abs(_lastX-e.x) < _DELTA_EPS &&
          Math.abs(_lastY-e.y) < _DELTA_EPS)
          openContextMenu(e.x, e.y);
      }
      function onContextMenu(e) {
        e.preventDefault();
      }
      function onClickToCancel(e) {
        if (e.button !== 1 && e.button !== 2)
          closeContextMenu();
      }
      function onContextMenuMobile(e) {
        openContextMenu(e.x, e.y);
        e.preventDefault();
      }

      function listen(node) {
        if (node && node.addEventListener) {
          // node.addEventListener("mouseup", onClick);
          window.addEventListener("mouseup", onClickToCancel, true);
          if (_this.isMobile) {
            node.addEventListener("contextmenu", onContextMenuMobile, true);
          }
          else {
            node.addEventListener("mousedown", onMouseDown, true);
            node.addEventListener("mouseup", onMouseUp, true);
            node.addEventListener("contextmenu", onContextMenu, false);
          }
        }
      }
      function unlisten(node) {
        if (node && node.removeEventListener) {
          // node.removeEventListener("mouseup", onClick);
          window.addEventListener("mouseup", onClickToCancel, true);
          if (_this.isMobile) {
            node.removeEventListener("contextmenu", onContextMenuMobile, true);
          }
          else {
            node.removeEventListener("mousedown", onMouseDown, true);
            node.removeEventListener("mouseup", onMouseUp, true);
            node.removeEventListener("contextmenu", onContextMenu, false);
          }
        }
      }

      Polymer({
        publish: {
          show: { value:false, reflect:true }
        },
        attached: function() {
          _this = this;
          if (!this.target)
            this.target = this.parentNode.host || this.parentNode;
          listen(this.target);
        },
        detached: function() {
          unlisten(this.target);
        },
        targetChanged: function(oldTarget, newTarget) {
          unlisten(oldTarget);
          listen(newTarget);
        }
      });
    })();
  </script>
</polymer-element>
