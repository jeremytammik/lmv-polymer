<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="lmv-tree-node" attributes="label expanded">
  <template>
    <link rel="stylesheet" href="lmv-tree-view.css">
    <link rel="stylesheet" href="lmv-tree-node.css">

    <table id="wrapper">
      <tr>
        <td class="icon" expanded="{{expanded}}" on-click="{{toggleExpand}}"></td>
        <td id="label"
          selected="{{selected}}"
          grayed="{{grayed}}"
          on-click="{{onNodeClick}}"
          on-dblclick="{{onNodeDoubleClick}}">
          {{label}}</td>
      </tr>
      <tr>
        <td id="content" expanded="{{expanded}}">
          <content></content>
        </td>
      </tr>
    </table>

  </template>
  <script>
    (function () {
      var _viewer;

      Polymer({
        domReady: function() {
          var self = this;

          // init expand logic
          if (this.children.length > 0)
            this.expanded = (this.expanded === undefined) ? false : this.expanded;
          else
            this.expanded = null;

          // grab viewer reference
          var viewerDom = document.querySelector("lmv-viewer");
          if (viewerDom) _viewer = viewerDom.viewer;

          // hook to viewer events
          _viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, function(event) {
            self.selected = false;
            for (var i=0; i<event.dbIdArray.length; i++) {
              self.selected = self.selected || (self.dataNode.dbId === event.dbIdArray[i]);
            }
          });
          _viewer.addEventListener(Autodesk.Viewing.HIDE_EVENT, function(event) {
            for (var i=0; i<event.nodeIdArray.length; i++) {
              self.grayed = self.grayed || (self.dataNode.dbId === event.nodeIdArray[i].dbId);
            }
          });
          _viewer.addEventListener(Autodesk.Viewing.ISOLATE_EVENT, function(event) {
            self.grayed = false;
            for (var i=0; i<event.nodeIdArray.length; i++) {
              self.grayed = self.grayed || (self.dataNode.dbId !== event.nodeIdArray[i].dbId);
            }
          });
        },
        toggleExpand: function() {
          if (this.expanded !== null)
            this.expanded = !this.expanded;
        },
        onNodeClick: function(event) {
          if (event.shiftKey || event.ctrlKey)
            _viewer.toggleSelect(this.dataNode.dbId);
          else
            _viewer.select(this.dataNode.dbId);
        },
        onNodeDoubleClick: function() {
          _viewer.fitToView(this.dataNode.dbId);
        }
      });
    })();
  </script>
</polymer-element>


<polymer-element name="lmv-tree-view" attributes="root">
  <template>
    <link rel="stylesheet" href="lmv-tree-view.css">
    <content></content>
  </template>
  <script>
    (function () {
      var buildTree = function(node, parentElem) {
        var newElem = document.createElement("lmv-tree-node");
        newElem.label = node.name;
        newElem.dataNode = node;  // pointer to backing data
        parentElem.appendChild(newElem);

        if (node.children) {
          for (var i=0; i<node.children.length; i++) {
            buildTree(node.children[i], newElem);
          }
        }
      };

      Polymer({
        rootChanged: function(oldRoot, root) {
          this.innerHTML = "";
          for (var i=0; i<root.children.length; i++) {
            buildTree(root.children[i], this);
          }
        }
      });
    })();
  </script>
</polymer-element>
