<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="lmv-model-tree-view" attributes="root">
  <template>
    <lmv-obj-context-menu></lmv-obj-context-menu>
    <content></content>
  </template>
  <script>
    (function () {
      var _viewer;
      var _shiftKey, _ctrlKey;

      Polymer({
        allNodes: [],   // cache flat reference to all nodes for fast iteration
        domReady: function() {
          // grab viewer reference
          var viewerDom = document.querySelector("lmv-viewer");
          if (viewerDom) _viewer = viewerDom.viewer;
          if (!_viewer) return;

          // viewer events update nodes
          var self = this;
          _viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, function(event) {
            for (var j=0; j<self.allNodes.length; j++) {
              var node = self.allNodes[j];
              node.selected = false;
              for (var i=0; i<event.dbIdArray.length; i++) {
                if (node.dataNode.dbId === event.dbIdArray[i]) {
                  node.selected = true;
                  break;
                }
              }
            }
          });
          _viewer.addEventListener(Autodesk.Viewing.HIDE_EVENT, function(event) {
            for (var j=0; j<self.allNodes.length; j++) {
              var node = self.allNodes[j];
              for (var i=0; i<event.nodeIdArray.length; i++) {
                if (node.dataNode.dbId === event.nodeIdArray[i].dbId) {
                  node.grayed = true;
                  break;
                }
              }
            }
          });
          _viewer.addEventListener(Autodesk.Viewing.ISOLATE_EVENT, function(event) {
            for (var j=0; j<self.allNodes.length; j++) {
              var node = self.allNodes[j];
              node.grayed = event.nodeIdArray.length ? true : false;
              for (var i=0; i<event.nodeIdArray.length; i++) {
                if (node.dataNode.dbId === event.nodeIdArray[i].dbId) {
                  node.grayed = false;
                  break;
                }
              }
            }
          });

          // track shift/ctrl modifier keys
          document.addEventListener("keydown", function(event) {
            _shiftKey = event.shiftKey;
            _ctrlKey = event.ctrlKey || (event.keyCode === 91) || (event.which === 91);
          }, true);
          document.addEventListener("keyup", function(event) {
            _shiftKey = event.shiftKey;
            _ctrlKey = event.ctrlKey || (event.keyCode === 91) || (event.which === 91);
          }, true);
        },
        buildTree: function(node, parentElem) {
          // create node
          var newElem = document.createElement("lmv-tree-node");
          newElem.label = node.name;
          newElem.dataNode = node;  // pointer to backing data
          newElem.addEventListener("node-click", this.onNodeClick);
          newElem.addEventListener("node-dblclick", this.onNodeDoubleClick);

          parentElem.appendChild(newElem);
          this.allNodes.push(newElem);  // cache reference

          // recursive
          if (node.children) {
            for (var i=0; i<node.children.length; i++) {
              this.buildTree(node.children[i], newElem);
            }
          }
        },
        rootChanged: function(oldRoot, root) {
          this.innerHTML = "";
          for (var i=0; i<root.children.length; i++) {
            this.buildTree(root.children[i], this);
          }
        },
        onNodeClick: function(event) {
          if (_shiftKey || _ctrlKey)
            _viewer.toggleSelect(event.target.dataNode.dbId);
          else
            if (!event.target.selected)
              _viewer.select(event.target.dataNode.dbId);
          event.stopPropagation();
        },
        onNodeDoubleClick: function(event) {
          _viewer.fitToView(event.target.dataNode.dbId);
          event.stopPropagation();
        },
      });
    })();
  </script>
</polymer-element>
