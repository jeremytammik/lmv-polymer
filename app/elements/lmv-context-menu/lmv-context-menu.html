<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="lmv-context-menu" attributes="">
  <template>
    <link rel="stylesheet" href="lmv-context-menu.css">
    <is-mobile id="isMobile"></is-mobile>
    <content></content>
  </template>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.4/hammer.min.js"></script>
  <script>
    (function () {
      var _lastX, _lastY;
      var _DELTA_EPS = 5;
      var _isMobile;

      function openContextMenu(x,y) {
        this.show = true;
        this.style.right = "calc( 100% - " + x + "px )";
        this.style.top = y + "px";
        this.fire("open");
      }
      function closeContextMenu() {
        this.show = false;
        this.fire("close");
      }

      function onMouseDown(e) {
        if (e.button !== 2)
          return;
        _lastX = e.x;
        _lastY = e.y;
      }
      function onMouseUp(e) {
        if (e.button !== 2)
          return;
        if (Math.abs(_lastX-e.x) < _DELTA_EPS &&
          Math.abs(_lastY-e.y) < _DELTA_EPS)
          openContextMenu.call(this, e.x, e.y);
      }
      function onContextMenu(e) {
        e.preventDefault();
      }
      function onClickToCancel() {
        closeContextMenu.call(this);
      }
      function onContextMenuMobile(e) {
        openContextMenu.call(this, e.center.x, e.center.y);
        e.preventDefault();
      }

      function listen(node) {
        if (node && node.addEventListener) {
          this.onClickToCancel = onClickToCancel.bind(this);
          window.addEventListener("mouseup", this.onClickToCancel, true);
          if (_isMobile) {
            // node.addEventListener("contextmenu", onContextMenuMobile, true);
            var mc = new Hammer(node.host);  // TODO_NOP: .host mobile workaround
            mc.on("press", onContextMenuMobile);
            // window.addEventListener("touchstart", onClickToCancel, false);
          }
          else {
            this.onClickToCancel = onClickToCancel.bind(this);
            this.onMouseDown = onMouseDown.bind(this);
            this.onMouseUp = onMouseUp.bind(this);
            this.onContextMenu = onContextMenu.bind(this);
            node.addEventListener("mousedown", this.onMouseDown, true);
            node.addEventListener("mouseup", this.onMouseUp, true);
            node.addEventListener("contextmenu", this.onContextMenu, false);
          }
        }
      }
      function unlisten(node) {
        if (node && node.removeEventListener) {
          window.removeEventListener("mouseup", this.onClickToCancel, true);
          if (_isMobile) {
            // node.removeEventListener("contextmenu", onContextMenuMobile, true);
            // window.addEventListener("touchstart", onClickToCancel, false);
          }
          else {
            node.removeEventListener("mousedown", this.onMouseDown, true);
            node.removeEventListener("mouseup", this.onMouseUp, true);
            node.removeEventListener("contextmenu", this.onContextMenu, false);
          }
        }
      }

      Polymer({
        publish: {
          show: { value:false, reflect:true }
        },
        domReady: function() {
          _isMobile = this.$.isMobile.mobile;
          if (!this.target)
            this.target = this.parentNode;
          listen.call(this, this.target);
        },
        detached: function() {
          unlisten.call(this, this.target);
        }
      });
    })();
  </script>
</polymer-element>
