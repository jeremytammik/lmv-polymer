<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="lmv-context-menu" attributes="">
  <template>
    <link rel="stylesheet" href="lmv-context-menu.css">
    <is-mobile id="isMobile"></is-mobile>
    <content></content>
  </template>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.4/hammer.min.js"></script>
  <script>
    (function () {
      var _this;
      var _lastX, _lastY;
      var _DELTA_EPS = 5;

      function openContextMenu(x,y) {
        _this.show = true;
        _this.style.right = "calc( 100% - " + x + "px )";
        _this.style.top = y + "px";
        _this.fire("open");
      }
      function closeContextMenu() {
        _this.show = false;
        _this.fire("close");
      }

      function onMouseDown(e) {
        if (e.button !== 2)
          return;
        _lastX = e.x;
        _lastY = e.y;
      }
      function onMouseUp(e) {
        if (e.button !== 2)
          return;
        if (Math.abs(_lastX-e.x) < _DELTA_EPS &&
          Math.abs(_lastY-e.y) < _DELTA_EPS)
          openContextMenu(e.x, e.y);
      }
      function onContextMenu(e) {
        e.preventDefault();
      }
      function onClickToCancel(e) {
        if (e.button !== 1 && e.button !== 2)
          closeContextMenu();
      }
      function onContextMenuMobile(e) {
        openContextMenu(e.center.x, e.center.y);
        e.preventDefault();
      }

      function listen(node) {
        if (node && node.addEventListener) {
          window.addEventListener("mouseup", onClickToCancel, true);
          if (_this.$.isMobile.mobile) {
            // node.addEventListener("contextmenu", onContextMenuMobile, true);
            var mc = new Hammer(node.host);  // TODO_NOP: .host mobile workaround
            mc.on("press", onContextMenuMobile);
            // window.addEventListener("touchstart", onClickToCancel, false);
          }
          else {
            node.addEventListener("mousedown", onMouseDown, true);
            node.addEventListener("mouseup", onMouseUp, true);
            node.addEventListener("contextmenu", onContextMenu, false);
          }
        }
      }
      function unlisten(node) {
        if (node && node.removeEventListener) {
          window.removeEventListener("mouseup", onClickToCancel, true);
          if (_this.$.isMobile.mobile) {
            // node.removeEventListener("contextmenu", onContextMenuMobile, true);
            // window.addEventListener("touchstart", onClickToCancel, false);
          }
          else {
            node.removeEventListener("mousedown", onMouseDown, true);
            node.removeEventListener("mouseup", onMouseUp, true);
            node.removeEventListener("contextmenu", onContextMenu, false);
          }
        }
      }

      Polymer({
        publish: {
          show: { value:false, reflect:true }
        },
        domReady: function() {
          _this = this;
          if (!this.target)
            this.target = this.parentNode;
          listen(this.target);
        },
        detached: function() {
          unlisten(this.target);
        }
      });
    })();
  </script>
</polymer-element>
